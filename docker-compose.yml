services:
  api:
    build: .
    container_name: twitch-q-backend
    environment:
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
      - TWITCH_CLIENT_SECRET: ${TWITCH_CLIENT_SECRET}
      - RESET_DB="0"
    env_file:
      - stack.env
    ports:
      - "7070:7070"
    volumes:
      - ./data:/data
  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    environment:
      BACKEND_URL: ${BACKEND_URL:-http://api:7070}
      ADMIN_TOKEN: ${ADMIN_TOKEN}
      BOT_NICK: ${BOT_NICK}
      COMMANDS_FILE: /bot/commands.yml
      BOT_MESSAGES_PATH: /bot/messages.yml
    env_file:
      - stack.env
    depends_on:
      - api
    restart: unless-stopped

    volumes:
      - ./bot/commands.yml:/bot/commands.yml:ro
      - ./bot/messages.yml:/bot/messages.yml:ro
  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    container_name: songqueue-web
    environment:
      BACKEND_URL: ${BACKEND_URL:-http://api:7070}
    env_file:
      - stack.env
    ports:
      - "${WEB_PORT:-7000}:80"
    restart: unless-stopped
    volumes:
      - ./web:/web
  queue_manager:
    build:
      context: .
      dockerfile: queue_manager/Dockerfile
    container_name: songqueue-queue-manager
    environment:
      BACKEND_URL: ${BACKEND_URL:-http://api:7070}
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
    env_file:
      - stack.env
    ports:
      - "${QUEUE_MANAGER_PORT:-7100}:80"
    restart: unless-stopped
    volumes:
      - ./queue_manager:/queue_manager
  admin:
    build:
      context: .
      dockerfile: admin/Dockerfile
    container_name: songqueue-admin
    environment:
      BACKEND_URL: ${BACKEND_URL:-http://api:7070}
      TWITCH_CLIENT_ID: ${TWITCH_CLIENT_ID}
    env_file:
      - stack.env
    ports:
      - "${ADMIN_PORT:-7171}:80"
    restart: unless-stopped
    volumes:
      - ./admin:/admin
